// webhook.mjs
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import fetch from 'node-fetch';
import bot from '../bot.mjs';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏ –∑–Ω–∞–Ω—å
const credentials = fs.readFileSync(path.join(__dirname, '../data/Vidzone_Credentials_Cleaned.md'), 'utf-8');

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
const guaranteeLetter = fs.readFileSync(path.join(__dirname, '../data/guarantee_letter.md'), 'utf-8');
const techRequirements = fs.readFileSync(path.join(__dirname, '../data/technical_requirements.md'), 'utf-8');
const musicCertificate = fs.readFileSync(path.join(__dirname, '../data/music_certificate.md'), 'utf-8');

export default async function handler(req, res) {
  const { body } = req;

  if (!body.message) return res.status(200).send('Non-message update skipped');

  const {
    chat: { id },
    text,
    from: { id: userId },
  } = body.message;

  console.log(`User asked: ${text}`); // –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É

  const allowedIds = process.env.ALLOWED_USER_IDS?.split(',') || [];

  if (!allowedIds.includes(userId.toString())) {
    await bot.sendMessage(id, '‚õîÔ∏è –¶–µ–π –±–æ—Ç —î –ø—Ä–∏–≤–∞—Ç–Ω–∏–º.');
    return res.status(200).send('Unauthorized user');
  }

  const userMessage = text?.toLowerCase().trim() || '';

  // === –õ–û–ì–Ü–ö–ê: —Å–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–¥–æ–º—ñ –∑–∞–ø–∏—Ç–∏

  // –ö–µ—Ä—ñ–≤–Ω–∏–∫ –∫–æ–º–ø–∞–Ω—ñ—ó
  if (userMessage.includes('–∫–µ—Ä—ñ–≤–Ω–∏–∫') || userMessage.includes('–¥–∏—Ä–µ–∫—Ç–æ—Ä') || userMessage.includes('—Å–µ–æ') || userMessage.includes('–≥–æ–ª–æ–≤–Ω–∏–π')) {
    await bot.sendMessage(id, 'CEO Vidzone ‚Äî –Ñ–≤–≥–µ–Ω –õ–µ–≤—á–µ–Ω–∫–æ.');
    return res.status(200).send('CEO Answer Sent');
  }

  // –î–æ–∫—É–º–µ–Ω—Ç–∏
  if (userMessage.includes('–º—É–∑–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞') || userMessage.includes('—à–∞–±–ª–æ–Ω –º—É–∑–∏—á–Ω–æ—ó –¥–æ–≤—ñ–¥–∫–∏')) {
    await bot.sendMessage(id, `üéº –ú—É–∑–∏—á–Ω–∞ –¥–æ–≤—ñ–¥–∫–∞:\n\n${musicCertificate}`);
    return res.status(200).send('Music Certificate Sent');
  }
  if (userMessage.includes('—Ç–µ—Ö–Ω—ñ—á–Ω—ñ –≤–∏–º–æ–≥–∏') || userMessage.includes('—à–∞–±–ª–æ–Ω —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –≤–∏–º–æ–≥')) {
    await bot.sendMessage(id, `üìÑ –¢–µ—Ö–Ω—ñ—á–Ω—ñ –≤–∏–º–æ–≥–∏:\n\n${techRequirements}`);
    return res.status(200).send('Technical Requirements Sent');
  }
  if (userMessage.includes('–≥–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π –ª–∏—Å—Ç') || userMessage.includes('—à–∞–±–ª–æ–Ω –≥–∞—Ä–∞–Ω—Ç—ñ–π–Ω–æ–≥–æ –ª–∏—Å—Ç–∞')) {
    await bot.sendMessage(id, `üìù –ì–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π –ª–∏—Å—Ç:\n\n${guaranteeLetter}`);
    return res.status(200).send('Guarantee Letter Sent');
  }

  // === GPT
  const systemPrompt = `
–¢–∏ ‚Äî –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π AI-–ø–æ–º—ñ—á–Ω–∏–∫ –∫–æ–º–ø–∞–Ω—ñ—ó Vidzone.

–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –¥—Ä—É–∂–Ω—å–æ —ñ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ. –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–∫–ª–∞–¥–Ω—ñ —Ç–µ—Ä–º—ñ–Ω–∏ –∞–±–æ –≤–∞–∂–∫—ñ —Ñ–æ—Ä–º—É–ª—é–≤–∞–Ω–Ω—è ‚Äî –≥–æ–≤–æ—Ä–∏ —Ç–∞–∫, –Ω—ñ–±–∏ –ø–æ—è—Å–Ω—é—î—à –∫–ª—ñ—î–Ω—Ç—É.

–Ø–∫—â–æ –∑–∞–ø–∏—Ç —Å—Ç–æ—Å—É—î—Ç—å—Å—è Vidzone (–ø–æ—Å–ª—É–≥–∏, —ñ—Å—Ç–æ—Ä—ñ—è, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏) ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –±–∞–∑—É –∑–Ω–∞–Ω—å –Ω–∏–∂—á–µ, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–≥–∞–ª—å–Ω–∞ –∞–±–æ –∫–æ—Ä–æ—Ç–∫–∞.

–Ø–∫—â–æ —Ç–æ—á–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–µ–º–∞—î ‚Äî –Ω–∞–¥–∞–π –∑–∞–≥–∞–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–∞—è–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö —ñ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ê–Ω–Ω–∏ –Ü–ª—å—î–Ω–∫–æ (a.ilyenko@vidzone.com).

–ù–µ –≤–∏–≥–∞–¥—É–π –¥–∞–Ω—ñ. –Ø–∫—â–æ –∑–∞–ø–∏—Ç –Ω–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è Vidzone –∞–±–æ OTT-—Ä–µ–∫–ª–∞–º–∏ ‚Äî –ø–æ—è—Å–Ω–∏, —â–æ –º–æ–∂–µ—à –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ Vidzone.

–í–∞–∂–ª–∏–≤–æ: –Ω–∞–¥–∞–≤–∞–π –ø—Ä–∏–∫–ª–∞–¥–∏, —è–∫—â–æ –≤–æ–Ω–∏ —î –≤ –±–∞–∑—ñ –∑–Ω–∞–Ω—å. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ñ–∞–∫—Ç–∏.

# –ë–∞–∑–∞ –∑–Ω–∞–Ω—å Vidzone:
${credentials}
`;

  try {
    const openaiRes = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: text },
        ],
      }),
    });

    const data = await openaiRes.json();
    console.log('OpenAI full response:', JSON.stringify(data, null, 2)); // –õ–æ–≥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

    const reply = data.choices?.[0]?.message?.content;

    if (reply && !reply.toLowerCase().includes('–Ω–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó')) {
      await bot.sendMessage(id, reply);
    } else {
      // Fallback —è–∫—â–æ GPT –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π—à–æ–≤
      await bot.sendMessage(id, `–Ø —â–µ –≤—á—É—Å—è, —Ç–æ–º—É –Ω–µ –Ω–∞ –≤—Å—ñ –ø–∏—Ç–∞–Ω–Ω—è –º–æ–∂—É –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏. –ê–ª–µ —Ç–æ—á–Ω–æ –¥–æ–ø–æ–º–æ–∂–µ –Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞! –ó–≤–µ—Ä—Ç–∞–π—Å—è –¥–æ –ê–Ω–Ω–∏ –Ü–ª—å—î–Ω–∫–æ: a.ilyenko@vidzone.com.`);
    }

    res.status(200).send('ok');
  } catch (err) {
    console.error('OpenAI error:', err);
    await bot.sendMessage(id, '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –ø—ñ–∑–Ω—ñ—à–µ.');
    res.status(500).send('OpenAI error');
  }
}
